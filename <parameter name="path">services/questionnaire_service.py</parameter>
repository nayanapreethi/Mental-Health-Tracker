<parameter name="content">"""Questionnaire service for PHQ-9 and GAD-7 assessment scoring."""

from typing import Dict, List, Tuple
from config.constants import PHQ9_QUESTIONS, PHQ9_OPTIONS, PHQ9_SEVERITY, GAD7_QUESTIONS, GAD7_OPTIONS, GAD7_SEVERITY


def get_phq9_questions() -> List[Dict]:
    """Get PHQ-9 questionnaire questions with metadata."""
    questions = []
    for i, question in enumerate(PHQ9_QUESTIONS):
        questions.append({
            "number": i + 1,
            "text": question,
            "options": PHQ9_OPTIONS
        })
    return questions


def get_gad7_questions() -> List[Dict]:
    """Get GAD-7 questionnaire questions with metadata."""
    questions = []
    for i, question in enumerate(GAD7_QUESTIONS):
        questions.append({
            "number": i + 1,
            "text": question,
            "options": GAD7_OPTIONS
        })
    return questions


def get_phq9_options() -> Dict[int, str]:
    """Get PHQ-9 response options."""
    return PHQ9_OPTIONS.copy()


def get_gad7_options() -> Dict[int, str]:
    """Get GAD-7 response options."""
    return GAD7_OPTIONS.copy()


def calculate_phq9_score(responses: Dict[int, int]) -> Tuple[int, str, str]:
    """
    Calculate PHQ-9 score and severity level.

    Args:
        responses: Dict mapping question number to response value (0-3)

    Returns:
        Tuple of (total_score, severity_label, recommendation)
    """
    total_score = sum(responses.values())

    # Determine severity
    severity_info = None
    for score_range, info in PHQ9_SEVERITY.items():
        if score_range[0] <= total_score <= score_range[1]:
            severity_info = info
            break

    if severity_info:
        return total_score, severity_info["level"], severity_info["recommendation"]

    return total_score, "Unknown", "Unable to determine severity level"


def calculate_gad7_score(responses: Dict[int, int]) -> Tuple[int, str, str]:
    """
    Calculate GAD-7 score and severity level.

    Args:
        responses: Dict mapping question number to response value (0-3)

    Returns:
        Tuple of (total_score, severity_label, recommendation)
    """
    total_score = sum(responses.values())

    # Determine severity
    severity_info = None
    for score_range, info in GAD7_SEVERITY.items():
        if score_range[0] <= total_score <= score_range[1]:
            severity_info = info
            break

    if severity_info:
        return total_score, severity_info["level"], severity_info["recommendation"]

    return total_score, "Unknown", "Unable to determine severity level"


def validate_phq9_responses(responses: Dict[int, int]) -> Tuple[bool, List[str]]:
    """
    Validate PHQ-9 responses.

    Args:
        responses: Dict mapping question number to response value

    Returns:
        Tuple of (is_valid, list of error messages)
    """
    errors = []

    # Check if all 9 questions are answered
    if len(responses) < 9:
        errors.append("Please answer all 9 questions")
        return False, errors

    # Check if question 9 is answered (suicidal ideation)
    if 9 not in responses:
        errors.append("Question 9 must be answered")
        return False, errors

    # Validate response values
    for q_num, value in responses.items():
        if not isinstance(value, int) or value < 0 or value > 3:
            errors.append(f"Invalid response for question {q_num}")
        elif value == 3:  # Suicidal ideation
            errors.append("If you're having thoughts of harming yourself, please reach out for help immediately")

    return len(errors) == 0, errors


def validate_gad7_responses(responses: Dict[int, int]) -> Tuple[bool, List[str]]:
    """
    Validate GAD-7 responses.

    Args:
        responses: Dict mapping question number to response value

    Returns:
        Tuple of (is_valid, list of error messages)
    """
    errors = []

    # Check if all 7 questions are answered
    if len(responses) < 7:
        errors.append("Please answer all 7 questions")
        return False, errors

    # Validate response values
    for q_num, value in responses.items():
        if not isinstance(value, int) or value < 0 or value > 3:
            errors.append(f"Invalid response for question {q_num}")

    return len(errors) == 0, errors


def get_clinical_recommendation(phq9_score: int, gad7_score: int) -> str:
    """
    Get overall clinical recommendation based on both scores.

    Args:
        phq9_score: PHQ-9 total score (0-27)
        gad7_score: GAD-7 total score (0-21)

    Returns:
        Clinical recommendation string
    """
    # Determine overall severity
    combined_score = phq9_score + gad7_score

    if combined_score <= 10:
        return ("Your assessment results suggest minimal symptoms of depression and anxiety. "
                "Continue maintaining your mental wellness routine with regular self-care practices.")
    elif combined_score <= 20:
        return ("Your assessment results suggest mild to moderate symptoms. "
                "Consider incorporating daily mindfulness exercises, regular physical activity, and "
                "speaking with a mental health professional if symptoms persist.")
    elif combined_score <= 35:
        return ("Your assessment results suggest moderate to moderately severe symptoms. "
                "We strongly recommend speaking with a mental health professional for further evaluation "
                "and support. In the meantime, try to maintain regular sleep, exercise, and social connections.")
    else:
        return ("Your assessment results suggest severe symptoms of depression and/or anxiety. "
                "Please seek professional help immediately. If you're in crisis, please reach out to "
                "a crisis hotline or emergency services. Your well-being is important and effective "
                "treatments are available.")
</parameter>
